{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Transform": "AWS::LanguageExtensions",
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label" : {
                        "default": "Network Configuration"
                    },
                    "Parameters": [
                        "VpcId",
                        "SubnetIds",
                        "SecurityGroupIds",
                        "CreateFsxServiceEndpoint",
                        "CreateSecretManagerEndpoint",
                        "CreateCloudWatchEndpoint"                        
                    ]
                },
                {
                    "Label" : {
                        "default": "Passwords Configuration"
                    },
                    "Parameters": [
                        "PasswordsSecretArn"
                    ]
                }                
            ],
            "ParameterLabels": {
                "VpcId": {
                    "default": "VPC ID"
                },
                "SubnetIds": {
                    "default": "Subnet IDs"
                },
                "SecurityGroupIds": {
                    "default": "Security Group IDs"
                },
                "CreateFsxServiceEndpoint": {
                    "default": "Create FSx Service Endpoint"
                },
                "CreateSecretManagerEndpoint": {
                    "default": "Create Secret Manager Endpoint"
                },
                "CreateCloudWatchEndpoint": {
                    "default": "Create CloudWatch Endpoint"
                },
                "PasswordsSecretArn": {
                    "default": "Secret Manager FSx admin passwords ARN - Optional"
                }                          
            }
        }
    },
    "Parameters": {
        "SubnetIds": {
            "Type": "List<AWS::EC2::Subnet::Id>",
            "Description": "The IDs of the subnets in which the Lambda function will run. These subnets must have connectivity to the file systems."
        },
        "SecurityGroupIds": {
            "Type": "List<AWS::EC2::SecurityGroup::Id>",
            "Description": "The IDs of the Security Groups that will be associated with the Lambda function when it runs. These Security Groups must allow connectivity to the file systems."
        },
        "VpcId": {
            "Type": "AWS::EC2::VPC::Id",
            "Description": "The ID of the VPC in which the Lambda function will run. This VPC must have connectivity to all target file systems. It can be either the same VPC where the file systems are located, or a different VPC with established connectivity (e.g., VPC peering, Transit Gateway) to the file systems' VPCs."
        },
        "CreateFsxServiceEndpoint": {
            "Type": "String",
            "AllowedValues": ["true", "false"],
            "Default": "false",
            "Description": "A boolean flag indicating whether you plan to create a FsxService VPC endpoint inside the VPC. Set this to true if you want to create the endpoint, or false if you don't. The decision to create this endpoint depends on whether you already have this type of endpoint. If you already have one, set this to false; otherwise, set it to true"
        },
        "PasswordsSecretArn": {
            "Type": "String",
            "Description": "The ARN of the AWS Secrets Manager secret containing fsxadmin passwords for ONTAP file systems. The secret should be structured as key-value pairs, where keys are file system IDs and values are their corresponding passwords. These credentials are required for ONTAP API calls, enabling functions like SnapMirror relation monitoring. If not provided, certain monitoring capabilities may be limited.",
            "Default": ""
        },
        "CreateSecretManagerEndpoint": {
            "Type": "String",
            "AllowedValues": ["true", "false"],
            "Default": "false",
            "Description": "A boolean flag indicating whether you plan to create a SecretManager VPC endpoint inside the VPC. Set this to true if you want to create the endpoint, or false if you don't. The decision to create this endpoint depends on whether you already have this type of endpoint. If you already have one, set this to false; otherwise, set it to true."
        }, 
        "CreateCloudWatchEndpoint": {
            "Type": "String",
            "AllowedValues": ["true", "false"],
            "Default": "false",
            "Description": "A boolean flag indicating whether you plan to create a CloudWatch VPC endpoint inside the VPC. Set this to true if you want to create the endpoint, or false if you don't. The decision to create this endpoint depends on whether you already have this type of endpoint. If you already have one, set this to false; otherwise, set it to true."
        }               
    },
    "Conditions": {
        "NeedToCreateFsxEP": {
            "Fn::Equals": [
                {
                    "Ref": "CreateFsxServiceEndpoint"
                },
                "true"
            ]
        },
        "NeedToCreateSSMEP": {
            "Fn::Equals": [
                {
                    "Ref": "CreateSecretManagerEndpoint"
                },
                "true"
            ]
        },        
        "NeedToCreateCWEP": {
            "Fn::Equals": [
                {
                    "Ref": "CreateCloudWatchEndpoint"
                },
                "true"
            ]
        },
        "NeedToCreateLambdaSecretPolicy": {
            "Fn::Not": [
                {
                    "Fn::Equals": [
                        {
                            "Ref": "PasswordsSecretArn"
                        },
                        ""
                    ]
                }
            ]
        }
    },    
    "Resources": {
        "SecretManagerEndPoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Condition": "NeedToCreateSSMEP",
            "Properties": {
                "VpcId": { "Ref": "VpcId"},
                "ServiceName": {
                    "Fn::Sub": [
                        "com.amazonaws.${Region}.secretsmanager",
                        {
                            "Region": {
                                "Ref": "AWS::Region"
                            }
                        }
                    ]
                },
                "SubnetIds": { "Ref": "SubnetIds"},
                "VpcEndpointType": "Interface",
                "PrivateDnsEnabled": true
            }
        },
        "FSxEndPoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Condition": "NeedToCreateFsxEP",
            "Properties": {
                "VpcId": { "Ref": "VpcId"},
                "ServiceName": {
                    "Fn::Sub": "com.amazonaws.${AWS::Region}.fsx"
                },
                "SubnetIds": { "Ref": "SubnetIds"},
                "VpcEndpointType": "Interface",
                "PrivateDnsEnabled": true
            }
        },
        "CloudWatchEndPoint": {
            "Type": "AWS::EC2::VPCEndpoint",
            "Condition": "NeedToCreateCWEP",
            "Properties": {
                "VpcId": { "Ref": "VpcId"},
                "ServiceName": {
                    "Fn::Sub": [
                        "com.amazonaws.${Region}.monitoring",
                        {
                            "Region": {
                                "Ref": "AWS::Region"
                            }
                        }
                    ]
                },
                "SubnetIds": { "Ref": "SubnetIds"},
                "VpcEndpointType": "Interface",
                "PrivateDnsEnabled": true
            }
        },        
        "LambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": [
                        "LambdaDashboardRole-${StackName}",
                        {
                            "StackName": {
                                "Ref": "AWS::StackName"
                            }
                        }
                    ]
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": {
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "lambda.amazonaws.com"
                        },
                        "Action": "sts:AssumeRole"
                    }
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
                    "arn:aws:iam::aws:policy/service-role/AWSLambdaRole"
                ],
                "Policies": [
                    {
                        "PolicyName": "LambdaPolicy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "ec2:CreateNetworkInterface",
                                        "ec2:DescribeNetworkInterfaces",
                                        "ec2:DeleteNetworkInterface",
                                        "ec2:AssignPrivateIpAddresses",
                                        "ec2:UnassignPrivateIpAddresses",
                                        "cloudwatch:PutMetricData",
                                        "fsx:DescribeFileSystems",
                                        "fsx:DescribeVolumes",
                                        "cloudwatch:DescribeAlarms",
                                        "cloudwatch:PutMetricAlarm"
                                    ],
                                    "Resource": "*"
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "cloudwatch:DeleteAlarms"
                                    ],
                                    "Resource": {
                                        "Fn::Join": [
                                            "",
                                            [
                                                "arn:aws:cloudwatch:",
                                                {"Ref": "AWS::Region"},
                                                ":",
                                                {"Ref": "AWS::AccountId"},
                                                ":alarm:FSx-ONTAP*"
                                            ]
                                        ]
                                    }
                                },
                                {
                                    "Fn::If": [
                                        "NeedToCreateLambdaSecretPolicy",
                                        {
                                            "Effect": "Allow",
                                            "Action": "secretsmanager:GetSecretValue",
                                            "Resource": {"Ref": "PasswordsSecretArn" }
                                        },
                                        {
                                            "Ref": "AWS::NoValue"
                                        }
                                    ]
                                    
                                }  
                            ]
                        }
                    }
                ]
            }
        },
        "LambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {"Fn::Join" : [ "-", [ "FSxNDashboard", {"Ref": "AWS::StackName"}] ]},
                "Code": {
                    "ImageUri": {
                        "Fn::Sub": [
                            "052582346341.dkr.ecr.${Region}.amazonaws.com/fsx-cloudwatch-dashboard:production",
                            {
                                "Region": {
                                    "Ref": "AWS::Region"
                                }
                            }
                         ]
                    }
                },
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaRole",
                        "Arn"
                    ]
                },
                "VpcConfig": {
                    "SecurityGroupIds": {
                        "Ref": "SecurityGroupIds"
                    },
                    "SubnetIds": {
                        "Ref": "SubnetIds"
                    }
                },
                "PackageType": "Image",
                "Timeout": 90,
                "Environment": {
                    "Variables": {
                        "NODE_TLS_REJECT_UNAUTHORIZED": "0",
                        "Version": "1.0.0",
                        "Region": {"Ref": "AWS::Region"}
                    }
                }
            }
        },
        "SchedulerRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub": [
                        "SchedulerFsxMonitoringRole-${StackName}",
                        {
                            "StackName": {
                                "Ref": "AWS::StackName"
                            }
                        }
                    ]
                },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": {
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "scheduler.amazonaws.com"
                        },
                        "Action": "sts:AssumeRole"
                    }
                },
                "Policies": [{
                    "PolicyName": "StatePolicy",
                    "PolicyDocument": {
                        "Version": "2012-10-17",
                        "Statement": [
                            {
                                "Effect": "Allow",
                                "Action": [
                                    "lambda:InvokeFunction"
                                ],
                                "Resource": {"Fn::GetAtt": [
                                    "LambdaFunction",
                                    "Arn"
                                ]}
                            }
                        ]
                    }
                }]
            }
        },        
        "MetricsScheduler": {
            "Type": "AWS::Scheduler::Schedule",
            "Properties": {
                "Name": {"Fn::Join" : [ "-", [ "NetAppFsxMonitoringScheduler", "metrics", {"Ref": "AWS::StackName"}] ] },
                "FlexibleTimeWindow": {
                    "Mode": "OFF"
                },
                "ScheduleExpression": "rate(1 minute)",
                "Target": {
                    "Arn": {
                        "Fn::GetAtt": [
                            "LambdaFunction",
                            "Arn"
                        ]
                    },
                    "RoleArn": {
                        "Fn::GetAtt": [
                            "SchedulerRole",
                            "Arn"
                        ]
                    },
                    "Input": {
                        "Fn::ToJsonString": {
                            "action": "putMetricsCommand",
                            "params": {
                                "secretArn": {"Ref": "PasswordsSecretArn"},
                                "region": {"Ref": "AWS::Region"}
                            }
                        }
                    }
                }
            }
        },
        "AlarmsScheduler": {
            "Type": "AWS::Scheduler::Schedule",
            "Properties": {
                "Name": {"Fn::Join" : [ "-", [ "NetAppFsxMonitoringScheduler", "alarms", {"Ref": "AWS::StackName"}] ] },
                "FlexibleTimeWindow": {
                    "Mode": "OFF"
                },
                "ScheduleExpression": "rate(1 hour)",
                "Target": {
                    "Arn": {
                        "Fn::GetAtt": [
                            "LambdaFunction",
                            "Arn"
                        ]
                    },
                    "RoleArn": {
                        "Fn::GetAtt": [
                            "SchedulerRole",
                            "Arn"
                        ]
                    },
                    "Input": {
                        "Fn::ToJsonString": {
                            "action": "manageAlarmsCommand",
                            "params": {
                                "secretArn": {"Ref": "PasswordsSecretArn"}
                            }
                        }
                    }
                }
            }
        },        
        "Dashboard": {
            "Type" : "AWS::CloudWatch::Dashboard",
            "DependsOn": "LambdaFunction",
            "Properties" : {
                "DashboardBody" : { "Fn::ToJsonString": {
                    "variables": [
                        {
                            "type": "pattern",
                            "pattern": "topFsx",
                            "inputType": "input",
                            "id": "topFsx",
                            "label": "topFsx",
                            "defaultValue": "5",
                            "visible": false
                        },
                        {
                            "type": "property",
                            "property": "FileSystemName",
                            "inputType": "input",
                            "id": "FileSystemName",
                            "label": "FileSystemName",
                            "visible": false
                        },
                        {
                            "type": "property",
                            "property": "FileSystemId",
                            "inputType": "input",
                            "id": "FileSystemId",
                            "label": "FileSystemId",
                            "visible": false
                        },
                        {
                            "type": "property",
                            "property": "VolumeName",
                            "inputType": "input",
                            "id": "VolumeName",
                            "label": "VolumeName",
                            "visible": false
                        },
                        {
                            "type": "property",
                            "property": "VolumeId",
                            "inputType": "input",
                            "id": "VolumeId",
                            "label": "VolumeId",
                            "visible": false
                        },
                        {
                            "type": "property",
                            "property": "alarmCategory",
                            "inputType": "input",
                            "id": "alarmCategory",
                            "label": "alarmCategory",
                            "defaultValue": "All",
                            "visible": false
                        },
                        {
                            "type": "property",
                            "property": "alarmState",
                            "inputType": "input",
                            "id": "alarmState",
                            "label": "alarmState",
                            "defaultValue": "All",
                            "visible": false
                        }                                                                                                    
                    ],                    
                    "widgets": [
                        {
                            "height": 4,
                            "width": 24,
                            "y": 0,
                            "x": 0,
                            "type": "custom",
                            "properties": {
                                "endpoint": { "Fn::Sub": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:FSxNDashboard-${AWS::StackName}"},
                                "updateOn": {
                                    "refresh": true,
                                    "resize": true,
                                    "timeRange": true
                                },
                                "params": {
                                    "action": "showFsxOverview",
                                    "limitFsx": "topFsx",
                                    "limitVolumes": "topVolumes",
                                    "FileSystemId": "",
                                    "FileSystemName": "",
                                    "VolumeId": "",
                                    "VolumeName": "",
                                    "alarmCategory": "All",
                                    "alarmState": "All"
                                }
                            }
                        },
                        {
                            "height": 8,
                            "width": 8,
                            "y": 4,
                            "x": 0,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ { "expression": "SELECT SUM(\"DataReadOperations\")\nFROM SCHEMA(\"AWS/FSx\", \"FileSystemId\")\nGROUP BY \"FileSystemId\"\nORDER BY SUM() DESC\nLIMIT topFsx", "label": "${LABEL}", "id": "q1", "region": {"Ref": "AWS::Region"}, "period": 300, "stat": "Sum", "visible": false } ],
                                    [ { "expression": "FLOOR(q1/PERIOD(FIRST(q1))*100)/100", "label": "", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "Operations per second"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Sum",
                                "period": 300,
                                "title": "Top topFsx NetApp-FSx Client Read Operations"
                            }
                        }, 
                        {
                            "height": 8,
                            "width": 8,
                            "y": 4,
                            "x": 8,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ { "expression": "SELECT SUM(\"DataWriteOperations\")\nFROM SCHEMA(\"AWS/FSx\", \"FileSystemId\")\nGROUP BY \"FileSystemId\"\nORDER BY SUM() DESC\nLIMIT topFsx", "label": "${LABEL}", "id": "q1", "region": {"Ref": "AWS::Region"}, "period": 300, "stat": "Sum", "visible": false } ],
                                    [ { "expression": "FLOOR(q1/PERIOD(FIRST(q1))*100)/100", "label": "", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "Operations per second"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Sum",
                                "period": 300,
                                "title": "Top topFsx NetApp-FSx Client Write Operations"
                            }
                        },                                               
                        {
                            "height": 8,
                            "width": 8,
                            "y": 4,
                            "x": 16,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ { "expression": "SELECT SUM(\"MetadataOperations\")\nFROM SCHEMA(\"AWS/FSx\", \"FileSystemId\")\nGROUP BY \"FileSystemId\"\nORDER BY SUM() DESC\nLIMIT topFsx", "label": "${LABEL}", "id": "q1", "region": {"Ref": "AWS::Region"}, "period": 300, "visible": false } ],
                                    [ { "expression": "FLOOR(q1/PERIOD(FIRST(q1))*100)/100", "label": "", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "Operations per second"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Sum",
                                "period": 300,
                                "title": "Top topFsx NetApp-FSx Client Metadata Operations"
                            }
                        },
                        {
                            "height": 8,
                            "width": 8,
                            "y": 12,
                            "x": 0,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ { "expression": "SELECT SUM(\"DataReadBytes\")\nFROM SCHEMA(\"AWS/FSx\", \"FileSystemId\")\nGROUP BY \"FileSystemId\"\nORDER BY SUM() DESC\nLIMIT topFsx", "label": "${LABEL}", "id": "q1", "region": {"Ref": "AWS::Region"}, "period": 300, "visible": false } ],
                                    [ { "expression": "FLOOR(q1/PERIOD(FIRST(q1))/1024/1024*100)/100", "label": "", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "MiB per second"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Sum",
                                "period": 300,
                                "title": "Top topFsx NetApp-FSx Client Read Megabytes"
                            }
                        },
                        {
                            "height": 8,
                            "width": 8,
                            "y": 12,
                            "x": 8,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ { "expression": "SELECT SUM(\"DataWriteBytes\")\nFROM SCHEMA(\"AWS/FSx\", \"FileSystemId\")\nGROUP BY \"FileSystemId\"\nORDER BY SUM() DESC\nLIMIT topFsx", "label": "${LABEL}", "id": "q1", "region": {"Ref": "AWS::Region"}, "period": 300, "visible": false } ],
                                    [ { "expression": "FLOOR(q1/PERIOD(FIRST(q1))/1024/1024*100)/100", "label": "", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "MiB per second"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Sum",
                                "period": 300,
                                "title": "Top topFsx NetApp-FSx Client Write Megabytes"
                            }
                        },
                        {
                            "height": 8,
                            "width": 8,
                            "y": 20,
                            "x": 0,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ { "expression": "SELECT SUM(\"DiskReadOperations\")\nFROM SCHEMA(\"AWS/FSx\", \"FileSystemId\")\nGROUP BY \"FileSystemId\"\nORDER BY SUM() DESC\nLIMIT topFsx", "label": "${LABEL}", "id": "q1", "region": {"Ref": "AWS::Region"}, "period": 300, "visible": false } ],
                                    [ { "expression": "FLOOR(q1/PERIOD(FIRST(q1))*100)/100", "label": "", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "Operations per second"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Sum",
                                "period": 300,
                                "title": "Top topFsx NetApp-FSx Disk Read Operations"
                            }
                        },
                        {
                            "height": 8,
                            "width": 8,
                            "y": 20,
                            "x": 8,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ { "expression": "SELECT SUM(\"DiskWriteOperations\")\nFROM SCHEMA(\"AWS/FSx\", \"FileSystemId\")\nGROUP BY \"FileSystemId\"\nORDER BY SUM() DESC\nLIMIT topFsx", "label": "${LABEL}", "id": "q1", "region": {"Ref": "AWS::Region"}, "period": 300, "visible": false } ],
                                    [ { "expression": "FLOOR(q1/PERIOD(FIRST(q1))*100)/100", "label": "", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "Operations per second"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Sum",
                                "period": 300,
                                "title": "Top topFsx NetApp-FSx Disk Write Operations"
                            }
                        },
                        {
                            "height": 8,
                            "width": 8,
                            "y": 28,
                            "x": 0,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ { "expression": "SELECT SUM(\"DiskReadBytes\")\nFROM SCHEMA(\"AWS/FSx\", \"FileSystemId\")\nGROUP BY \"FileSystemId\"\nORDER BY SUM() DESC\nLIMIT topFsx", "label": "${LABEL}", "id": "q1", "region": {"Ref": "AWS::Region"}, "period": 300, "visible": false } ],
                                    [ { "expression": "FLOOR(q1/1024/1024/PERIOD(FIRST(q1))*100)/100", "label": "", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "MiB per second"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": { "Ref": "AWS::Region" },
                                "stat": "Sum",
                                "period": 300,
                                "title": "Top topFsx NetApp-FSx Disk Read Megabytes"
                            }
                        },
                        {
                            "height": 8,
                            "width": 8,
                            "y": 28,
                            "x": 8,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ { "expression": "SELECT SUM(\"DiskWriteBytes\")\nFROM SCHEMA(\"AWS/FSx\", \"FileSystemId\")\nGROUP BY \"FileSystemId\"\nORDER BY SUM() DESC\nLIMIT topFsx", "label": "${LABEL}", "id": "q1", "region": {"Ref": "AWS::Region"}, "period": 300, "visible": false } ],
                                    [ { "expression": "FLOOR(q1/1024/1024/PERIOD(FIRST(q1))*100)/100", "label": "", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "MiB per second"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Sum",
                                "period": 300,
                                "title": "Top topFsx NetApp-FSx Disk Write Megabytes"
                            }
                        },
                        {
                            "height": 8,
                            "width": 8,
                            "y": 12,
                            "x": 16,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ { "expression": "SELECT AVG(StorageUsed) FROM SCHEMA(\"AWS/FSx\", DataType,FileSystemId,StorageTier) WHERE StorageTier = 'SSD' GROUP BY FileSystemId ORDER BY AVG() DESC LIMIT topFsx", "label": "${LABEL}", "id": "q1", "region": {"Ref": "AWS::Region"}, "visible": false } ],
                                    [ { "expression": "FLOOR(q1*9.313225746154785e-10)", "label": "", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "GiB"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Average",
                                "period": 300,
                                "title": "Top topFsx NetApp-FSx SSD Storage Used"
                            }
                        },                        
                        {
                            "height": 8,
                            "width": 8,
                            "y": 20,
                            "x": 16,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ { "expression": "SELECT AVG(StorageUsed) FROM SCHEMA(\"AWS/FSx\", DataType,FileSystemId,StorageTier) WHERE StorageTier = 'StandardCapacityPool' GROUP BY FileSystemId ORDER BY AVG() DESC LIMIT topFsx", "label": "${LABEL}", "id": "q1", "region": {"Ref": "AWS::Region"}, "visible": false } ],
                                    [ { "expression": "FLOOR(q1*9.313225746154785e-10)", "label": "", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "GiB"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Average",
                                "period": 300,
                                "title": "Top topFsx NetApp-FSx Capacity Pool"
                            }
                        },
                        {
                            "height": 6,
                            "width": 24,
                            "y": 44,
                            "x": 0,
                            "type": "custom",
                            "properties": {
                                "endpoint": { "Fn::Sub": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:FSxNDashboard-${AWS::StackName}"},
                                "updateOn": {
                                    "refresh": true,
                                    "resize": true,
                                    "timeRange": true
                                },
                                "params": {
                                    "action": "showMetricsByFsx",
                                    "limitFsx": "topFsx",
                                    "limitVolumes": "topVolumes",
                                    "FileSystemId": "",
                                    "FileSystemName": "",
                                    "VolumeId": "",
                                    "VolumeName": "",
                                    "alarmCategory": "All",
                                    "alarmState": "All"                                    
                                }
                            }
                        },
                        {
                            "type": "metric",
                            "x": 0,
                            "y": 50,
                            "width": 8,
                            "height": 8,
                            "properties": {
                                "metrics": [
                                    [ "AWS/FSx", "DataWriteOperations", "FileSystemId", "\"\"", { "id": "m1", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ ".", "DataReadOperations", ".", ".", { "id": "m2", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ ".", "MetadataOperations", ".", ".", { "id": "m3", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ { "expression": "FLOOR(m1/PERIOD(m1)*100)/100", "label": "Client Write OPS", "id": "e1" } ],
                                    [ { "expression": "FLOOR(m2/PERIOD(m2)*100)/100", "label": "Client Read OPS", "id": "e2" } ],
                                    [ { "expression": "FLOOR(m3/PERIOD(m3)*100)/100", "label": "Client Meta OPS", "id": "e3" } ],
                                    [ { "expression": "FLOOR(SUM(METRICS())/PERIOD(m2)*100)/100", "label": "Total Client OPS", "id": "e4" } ]
                                ],
                                "title": "Client IOPS",
                                "view": "timeSeries",
                                "period": 60,
                                "stacked": false,
                                "stat": "Sum",
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "Operations per second"
                                    }
                                },
                                "region": {"Ref": "AWS::Region"}
                            }
                        },
                        {
                            "type": "metric",
                            "x": 8,
                            "y": 50,
                            "width": 8,
                            "height": 8,
                            "properties": {
                                "metrics": [
                                    [ "AWS/FSx", "DataReadBytes", "FileSystemId", "\"\"", { "id": "m1", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ ".", "DataWriteBytes", ".", ".", { "id": "m2", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ { "id": "e1", "expression": "FLOOR(SUM(METRICS())/PERIOD(m1)/1024/1024*100)/100", "label": "Total client throughput", "color": "#1F77B4" } ],
                                    [ { "id": "e2", "expression": "FLOOR(m1/PERIOD(m1)/1024/1024*100)/100", "label": "Client MiB Read" }],
                                    [ { "id": "e3", "expression": "FLOOR(m2/PERIOD(m2)/1024/1024*100)/100", "label": "Client MiB Written" }]
                                ],
                                "view": "timeSeries",
                                "title": "Client Throughput",
                                "period": 60,
                                "stacked": false,
                                "stat": "Sum",
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "MiB per second"
                                    }
                                },
                                "region": {"Ref": "AWS::Region"}
                            }
                        },                        
                        {
                            "type": "metric",
                            "x": 16,
                            "y": 50,
                            "width": 8,
                            "height": 8,
                            "properties": {
                                "metrics": [
                                    [ "AWS/FSx", "DiskReadOperations", "FileSystemId", "\"\"", { "id": "m1", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ ".", "DiskWriteOperations", ".", ".", { "id": "m2", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ { "id": "e1", "expression": "FLOOR(m1/PERIOD(m1)*100)/100", "label": "Disk Read Ops"} ],
                                    [ { "id": "e2", "expression": "FLOOR(m2/PERIOD(m2)*100)/100", "label": "Disk Write Ops"} ],
                                    [ { "id": "e3", "expression": "FLOOR(SUM(METRICS())/PERIOD(m1)*100)/100", "label": "Total disk Ops", "region": {"Ref": "AWS::Region"}, "yAxis": "left" } ]
                                ],
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Sum",
                                "period": 300,
                                "title": "Disk OPS",
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "Operations per second"
                                    }
                                }
                            }
                        },
                        {
                            "type": "metric",
                            "x": 0,
                            "y": 58,
                            "width": 8,
                            "height": 8,
                            "properties": {
                                "metrics": [
                                    [ "AWS/FSx", "DiskReadBytes", "FileSystemId", "\"\"", { "id": "m1", "region": {"Ref": "AWS::Region"}, "label": "DiskReadBytes", "visible": false } ],
                                    [ ".", "DiskWriteBytes", ".", ".", { "id": "m2", "region": {"Ref": "AWS::Region"}, "label": "DiskReadBytes", "visible": false } ],
                                    [ { "expression": "FLOOR(m1/1024/1024/PERIOD(m1)*100)/100", "label": "DiskReadMegabytes", "id": "e1", "region": {"Ref": "AWS::Region"}, "yAxis": "left" } ],
                                    [ { "expression": "FLOOR(m2/1024/1024/PERIOD(m2)*100)/100", "label": "DiskWriteMegabytes", "id": "e2", "region": {"Ref": "AWS::Region"}, "yAxis": "left" } ],
                                    [ { "expression": "FLOOR((e1+e2)*100)/100", "label": "Total disk MBs", "id": "e3", "region": {"Ref": "AWS::Region"}, "yAxis": "left" } ]
                                ],
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Sum",
                                "period": 300,
                                "title": "Disk Throughput",
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "MiB per second"
                                    }
                                }
                            }
                        },
                        {
                            "type": "metric",
                            "x": 8,
                            "y": 58,
                            "width": 8,
                            "height": 8,
                            "properties": {
                                "metrics": [
                                    [ { "id": "e1", "expression": "FLOOR(1000 * m2/(m1+0.000001)*100)/100", "label": "Write operations", "color": "#1F77B4", "region": {"Ref": "AWS::Region"} } ],
                                    [ { "id": "e2", "expression": "FLOOR(1000 * m4/(m3+0.000001)*100)/100", "label": "Read operations", "color": "#F89256", "region": {"Ref": "AWS::Region"} } ],
                                    [ { "id": "e3", "expression": "FLOOR(1000 * m6/(m5+0.000001)*100)/100", "label": "Metadata operations", "color": "#2CA02C", "region": {"Ref": "AWS::Region"} } ],
                                    [ { "id": "e4", "expression": "FLOOR((e1+e2+e3)*100)/100", "label": "Total operations", "region": {"Ref": "AWS::Region"} } ],
                                    [ "AWS/FSx", "DataWriteOperations", "FileSystemId", "\"\"", { "id": "m1", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ ".", "DataWriteOperationTime", ".", ".", { "id": "m2", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ ".", "DataReadOperations", ".", ".", { "id": "m3", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ ".", "DataReadOperationTime", ".", ".", { "id": "m4", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ ".", "MetadataOperations", ".", ".", { "id": "m5", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ ".", "MetadataOperationTime", ".", ".", { "id": "m6", "visible": false, "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "title": "Average Latency",
                                "view": "timeSeries",
                                "period": 60,
                                "stacked": false,
                                "stat": "Sum",
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "Milliseconds",
                                        "min": 0
                                    }
                                },
                                "region": {"Ref": "AWS::Region"}
                            }
                        },
                        {
                            "type": "metric",
                            "x": 16,
                            "y": 58,
                            "width": 8,
                            "height": 8,
                            "properties": {
                                "metrics": [
                                    [ "AWS/FSx", "StorageUsed", "FileSystemId", "\"\"", "StorageTier", "SSD", "DataType", "All", { "id": "m3", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ ".", "StorageCapacity", ".", ".", ".", ".", ".", ".", { "id": "m1", "visible": false, "region": {"Ref": "AWS::Region"} } ],
                                    [ { "id": "e1", "expression": "FLOOR((m1-m3)/1024/1024/1024)", "label": "Primary tier - available", "color": "#2CA02C", "region": {"Ref": "AWS::Region"} } ],
                                    [ { "id": "e2", "expression": "FLOOR(m3/1024/1024/1024)", "label": "Primary tier - used", "color": "#1F77B4", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "title": "Primary Tier - Storage Utilization",
                                "view": "pie",
                                "period": 60,
                                "stacked": false,
                                "stat": "Average",
                                "yAxis": {
                                    "left": {
                                        "showUnits": false
                                    }
                                },
                                "region": {"Ref": "AWS::Region"}
                            }
                        },
                        {
                            "type": "metric",
                            "x": 0,
                            "y": 66,
                            "width": 5,
                            "height": 8,
                            "properties": {
                                "metrics": [
                                    [ { "expression": "FLOOR(m1*9.3132257461548E-10)", "label": "Capacity pool tier (GiB)", "id": "e1", "region": {"Ref": "AWS::Region"} } ],
                                    [ "AWS/FSx", "StorageUsed", "FileSystemId", "\"\"", "StorageTier", "StandardCapacityPool", "DataType", "All", { "id": "m1", "label": "Capacity pool tier (Bytes)", "color": "#F89256", "region": {"Ref": "AWS::Region"}, "visible": false } ]
                                ],
                                "title": "Capacity Tier",
                                "view": "singleValue",
                                "period": 60,
                                "stacked": false,
                                "stat": "Average",
                                "yAxis": {
                                    "left": {
                                        "showUnits": false
                                    }
                                },
                                "region": {"Ref": "AWS::Region"}
                            }
                        },
                        {
                            "height": 8,
                            "width": 19,
                            "y": 66,
                            "x": 5,
                            "type": "custom",
                            "properties": {
                                "endpoint": { "Fn::Sub": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:FSxNDashboard-${AWS::StackName}"},
                                "updateOn": {
                                    "refresh": true,
                                    "resize": true,
                                    "timeRange": true
                                },
                                "params": {
                                    "action": "showSnapMirrorCommand",
                                    "params": {
                                        "FileSystemId": "",
                                        "secretArn": {"Ref": "PasswordsSecretArn"},
                                        "region": {"Ref": "AWS::Region"}
                                    }
                                },
                                "title": "SnapMirror Relationships"
                            }
                        },                        
                        {
                            "height": 6,
                            "width": 24,
                            "y": 74,
                            "x": 0,
                            "type": "custom",
                            "properties": {
                                "endpoint": { "Fn::Sub": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:FSxNDashboard-${AWS::StackName}"},
                                "updateOn": {
                                    "refresh": true,
                                    "resize": true,
                                    "timeRange": true
                                },
                                "params": {
                                    "action": "showMetricsByVolume",
                                    "limitFsx": "topFsx",
                                    "limitVolumes": "topVolumes",
                                    "FileSystemId": "",
                                    "FileSystemName": "",
                                    "VolumeId": "",
                                    "VolumeName": "",
                                    "alarmCategory": "All",
                                    "alarmState": "All"                                    
                                }
                            }
                        },
                        {
                            "height": 8,
                            "width": 8,
                            "y": 80,
                            "x": 0,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ "AWS/FSx", "StorageCapacityUtilization", "VolumeId", "\"\"", "FileSystemId", "\"\"", { "region": {"Ref": "AWS::Region"}, "id": "m1", "visible": false } ],
                                    [ { "expression": "FLOOR(m1)", "label": "StorageCapacityUtilization", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "Precentage",
                                        "min": 0
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Average",
                                "period": 300,
                                "title": "Volume Utilization"
                            }
                        },
                        {
                            "height": 8,
                            "width": 8,
                            "y": 80,
                            "x": 8,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ "AWS/FSx", "DataWriteOperations", "VolumeId", "\"\"", "FileSystemId", "\"\"", { "region": {"Ref": "AWS::Region"}, "id": "m1", "visible": false } ],
                                    [ { "expression": "FLOOR(m1/PERIOD(m1)*100)/100", "label": "DataWriteOperations", "id": "e2", "region": {"Ref": "AWS::Region"} } ],
                                    [ "AWS/FSx", "DataReadOperations", "VolumeId", "\"\"", "FileSystemId", "\"\"", { "region": {"Ref": "AWS::Region"}, "id": "m2", "visible": false } ],
                                    [ { "expression": "FLOOR(m2/PERIOD(m2)*100)/100", "label": "DataReadOperations", "id": "e3", "region": {"Ref": "AWS::Region"} } ],
                                    [ "AWS/FSx", "MetadataOperations", "VolumeId", "\"\"", "FileSystemId", "\"\"", { "region": {"Ref": "AWS::Region"}, "id": "m3", "visible": false } ],
                                    [ { "expression": "FLOOR(m3/PERIOD(m3)*100)/100", "label": "MetadataOperations", "id": "e4", "region": {"Ref": "AWS::Region"} } ],
                                    [ { "expression": "FLOOR(SUM(METRICS())/PERIOD(m1)*100)/100", "label": "Total IOPS", "id": "e1", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "Operations per second"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Sum",
                                "period": 300,
                                "title": "Volume IOPS"
                            }
                        },
                        {
                            "height": 8,
                            "width": 8,
                            "y": 80,
                            "x": 16,
                            "type": "metric",
                            "properties": {
                                "metrics": [
                                    [ "AWS/FSx", "DataReadBytes", "VolumeId", "\"\"", "FileSystemId", "\"\"", { "region": {"Ref": "AWS::Region"}, "id": "m1", "label": "DataReadBytes", "visible": false } ],
                                    [ "AWS/FSx", "DataWriteBytes", "VolumeId", "\"\"", "FileSystemId", "\"\"", { "region": {"Ref": "AWS::Region"}, "id": "m2", "label": "DataWriteBytes", "visible": false } ],
                                    [ { "expression": "FLOOR(m1/PERIOD(m1)/1024/1024*100)/100", "label": "DataReadBytes", "id": "e1", "region": {"Ref": "AWS::Region"} } ],
                                    [ { "expression": "FLOOR(m2/PERIOD(m2)/1024/1024*100)/100", "label": "DataWriteBytes", "id": "e2", "region": {"Ref": "AWS::Region"} } ],
                                    [ { "expression": "FLOOR(SUM(METRICS())/PERIOD(m1)/1024/1024*100)/100", "label": "Total Throughput", "id": "e3", "region": {"Ref": "AWS::Region"} } ]
                                ],
                                "yAxis": {
                                    "left": {
                                        "showUnits": false,
                                        "label": "MiB per second"
                                    }
                                },
                                "view": "timeSeries",
                                "stacked": false,
                                "region": {"Ref": "AWS::Region"},
                                "stat": "Sum",
                                "period": 300,
                                "title": "Volume Throughput"
                            }
                        },
                        {
                            "type": "custom",
                            "x": 0,
                            "y": 88,
                            "width": 24,
                            "height": 13,
                            "properties": {
                                "endpoint": { "Fn::Sub": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:FSxNDashboard-${AWS::StackName}"},
                                "updateOn": {
                                    "refresh": true,
                                    "resize": true,
                                    "timeRange": true
                                },
                                "params": {
                                    "action": "showAlarms",
                                    "limitFsx": "topFsx",
                                    "limitVolumes": "topVolumes",
                                    "FileSystemId": "",
                                    "FileSystemName": "",
                                    "VolumeId": "",
                                    "VolumeName": "",
                                    "alarmCategory": "All",
                                    "alarmState": "All"
                                }
                            }
                        }                                                                                                                        

                    ]
                }},
                "DashboardName" : {"Fn::Join" : [ "-", [ "NetApp-FSx-Dashboard", {"Ref": "AWS::Region"}, {"Fn::Select": ["4", {"Fn::Split": ["-", {"Fn::Select": [2, {"Fn::Split": ["/", {"Ref": "AWS::StackId"}]}]}]}]}     ] ]}
              }
        }
    }
}
